(window.webpackJsonp=window.webpackJsonp||[]).push([[56],{596:function(t,s,n){"use strict";n.r(s);var a=n(12),e=Object(a.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h2",{attrs:{id:"_1-单线程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-单线程"}},[t._v("#")]),t._v(" 1.单线程")]),t._v(" "),n("p",[t._v("所谓的单线程，可以简单理解为做事情讲究先来后到，要做后面的事情，你得等前面的事情做完 —— 不管它需要多久。")]),t._v(" "),n("blockquote",[n("p",[t._v("既然如此，JS 引擎为何还要采取这种单线程的机制呢？")])]),t._v(" "),n("p",[t._v("JS 主要是与用户互动，这个过程涉及到对 DOM 节点的操作，如果 JS 是多线程的，一个线程在节点上添加内容，一个线程却要删除这个 DOM 节点，到底要以哪个为准呢？所以这就是为什么 JS 从一出现就秉承着单线程的运行机制。")]),t._v(" "),n("p",[t._v("另外还要注意：为了利用多核 CPU 的计算能力，HTML5 提出 Web Worker 标准，允许 JavaScript 脚本创建多个线程，但是子线程完全受主线程控制，且不得操作 DOM。所以，这个新标准并没有改变 JavaScript 单线程的本质。")]),t._v(" "),n("h2",{attrs:{id:"_2-同步任务和异步任务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-同步任务和异步任务"}},[t._v("#")]),t._v(" 2.同步任务和异步任务")]),t._v(" "),n("p",[t._v("很显然，单线程会带来一个问题：就是代码执行的阻塞。比如：排在前面的任务如果耗时长，则后面的任务不得不一直等待它。 如果说耗时长是因为计算量大、CPU 一直忙着计算的话倒也还好，可事实是 —— 大部分时间浪费在了 IO 上（Ajax 从网络上获取数据），还有其他的如鼠标点击、setTimeout 等等。因此这里提出了同步任务和异步任务的概念。")]),t._v(" "),n("p",[t._v("在 JS 中，可以将同步和异步简单理解为执行顺序的问题。")]),t._v(" "),n("h3",{attrs:{id:"同步-sync"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#同步-sync"}},[t._v("#")]),t._v(" 同步（sync）：")]),t._v(" "),n("p",[t._v("即上面所说的后面等待前面。同步对应了同步任务（synchronous），即可以按照正常顺序执行的任务，比如加载页面骨架等。")]),t._v(" "),n("h3",{attrs:{id:"异步-async"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#异步-async"}},[t._v("#")]),t._v(" 异步（async）：")]),t._v(" "),n("p",[t._v("即把耗时长的任务挂起，先执行耗时短的，再回过头执行耗时长的。\n异步对应了异步任务（asynchronous），即不适合按照正常顺序执行的任务，主要包括：")]),t._v(" "),n("ul",[n("li",[t._v("onclick　等事件绑定：当事件触发之后，回调函数会被添加到任务队列中")]),t._v(" "),n("li",[t._v("setTimeout/setInterval 等计时器：当浏览器完成计时之后，回调函数会被添加到任务队列中；")]),t._v(" "),n("li",[t._v("AJAX　请求：当网络请求完成返回之后，回调函数会被添加到任务队列中")])]),t._v(" "),n("h2",{attrs:{id:"_3-事件循环"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-事件循环"}},[t._v("#")]),t._v(" 3.事件循环")]),t._v(" "),n("p",[t._v("事件循环又叫 Event loop，它是由 JS 引擎的运行环境（浏览器或 Nodejs）提供的一种事件调度机制。")]),t._v(" "),n("p",[t._v("事件循环是实现异步的一种机制。一个线程中只有一个事件循环，我们将这个循环的每一次循环执行过程称之为一个 tick。 具体每一次循环是怎么执行的，后文会讲。")]),t._v(" "),n("h2",{attrs:{id:"_4-执行栈和任务队列"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-执行栈和任务队列"}},[t._v("#")]),t._v(" 4.执行栈和任务队列")]),t._v(" "),n("p",[t._v("事件循环机制离不开执行栈和任务队列的相互配合。js中将同步任务放到主线程上执行，形成“执行栈”；异步任务则放到任务队列中。")]),t._v(" "),n("p",[n("strong",[t._v("任务队列的分类标准之一：")])]),t._v(" "),n("p",[t._v("一个线程可以拥有多个任务队列。每一个任务队列都对应某一任务源，并包含了一堆来自该任务源的任务。任务源是什么？像setTimeout/Promise/DOM事件/AJAX 等都是任务源，来自同类任务源的任务我们称它们是同源的，比如 setTimeout 与 setInterval 就是同源的。")]),t._v(" "),n("p",[n("strong",[t._v("任务队列的分类标准之二：")])]),t._v(" "),n("p",[t._v("在 ES6 中，我们用另一种方式对任务队列进行分类。")]),t._v(" "),n("ul",[n("li",[t._v("宏任务：即 macro-task，包括整体 script 代码、setTimeout、setInterval、AJAX、用户I\\O 等。宏任务会对应地进入宏任务队列中；")]),t._v(" "),n("li",[t._v("微任务：即 micro-task，包括 Promise、"),n("code",[t._v("process.nextTick(callback)")]),t._v("（可以理解为 Nodejs 版的 setTimeOut）。微任务会对应地进入微任务队列中。")])]),t._v(" "),n("h2",{attrs:{id:"_5-事件循环的具体运作过程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-事件循环的具体运作过程"}},[t._v("#")]),t._v(" 5.事件循环的具体运作过程")]),t._v(" "),n("p",[t._v("总的来说，事件循环的顺序，决定了 JS 代码执行的顺序。")]),t._v(" "),n("ul",[n("li",[n("p",[t._v("第一次循环开始（tick one）")]),t._v(" "),n("ul",[n("li",[t._v("宏任务：首先执行 "),n("code",[t._v("<script>")]),t._v(" 包裹的整体代码。同步任务直接执行，异步任务分发到对应的任务队列中")]),t._v(" "),n("li",[t._v("微任务：整体代码执行完，执行栈清空。开始读取微任务队列中的所有微任务，全部执行")])])]),t._v(" "),n("li",[n("p",[t._v("第一次循环结束，第二次循环开始（tick two）")]),t._v(" "),n("ul",[n("li",[t._v("宏任务：读取宏任务队列中的一个宏任务，执行")]),t._v(" "),n("li",[t._v("微任务：读取微任务队列中的所有微任务，全部执行")])])]),t._v(" "),n("li",[n("p",[t._v("第二次循环结束，第三次循环开始（tick three）")]),t._v(" "),n("ul",[n("li",[t._v("……")])])])]),t._v(" "),n("p",[t._v("最终，所有的队列都清空，执行栈也清空，事件循环正式结束。")]),t._v(" "),n("p",[t._v("PS：执行任务指的其实是执行这些任务指定的回调函数，并且要注意：若回调函数中又有宏任务，则该宏任务会被安排到下一轮循环中，不会在这一轮就执行。")]),t._v(" "),n("h2",{attrs:{id:"_6-事件循环的例子"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-事件循环的例子"}},[t._v("#")]),t._v(" 6.事件循环的例子")]),t._v(" "),n("p",[t._v("下面通过三个由易到难的例子来理解上面所说的过程。")]),t._v(" "),n("h3",{attrs:{id:"例一"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#例一"}},[t._v("#")]),t._v(" 例一")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("task")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("，"),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("3000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 同步的睡眠函数")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sleep")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("10000000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("p",[t._v("分析：\n跑一下代码，会发现控制台执行 "),n("code",[t._v("task()")]),t._v(' 需要的时间远远超过 3 秒，这就说明我们有的人理解的"setTimeout 的第二个参数指定了多长时间后执行回调函数"的说法是错误的。\n让我们来分析一下这个过程：')]),t._v(" "),n("ul",[n("li",[n("code",[t._v("<script>")]),t._v(" 中的整段代码作为第一次循环的宏任务，进入主线程。即开启第一次事件循环；")]),t._v(" "),n("li",[t._v("首先遇到了 setTimeout，将其回调函数 "),n("code",[t._v("task()")]),t._v(" 进入 Event Table 并注册，同时浏览器开始计时；")]),t._v(" "),n("li",[t._v("继续，遇到了 sleep 函数，这是一个同步的睡眠任务，所以直接执行。但是速度很慢，非常慢，而浏览器计时仍在继续；")]),t._v(" "),n("li",[t._v("好了，3 秒终于到了，计时事件 setTimeout 总算完成，可以把 "),n("code",[t._v("task()")]),t._v(" 放入任务队列了;")]),t._v(" "),n("li",[t._v("但是主线程上的 sleep 太慢了，还没执行完，于是我们只好等着；")]),t._v(" "),n("li",[t._v("sleep 终于执行完了，执行栈清空，第一次循环的宏任务结束；")]),t._v(" "),n("li",[t._v("读取微任务队列，但是没有微任务，所以第一次循环结束了；")]),t._v(" "),n("li",[t._v("第二次循环开始，读取宏任务队列，刚好，里面有一个 setTimeout 对应的 "),n("code",[t._v("task()")]),t._v(" 回调函数，压栈、令其进入主线程执行；")]),t._v(" "),n("li",[t._v("执行栈清空了，任务队列也清空了，事件循环正式结束。")])]),t._v(" "),n("p",[t._v("现在，我们知道 setTimeout 的回调函数是一开始就注册进 Event Table 的，但是那时并未进入任务队列 —— 要经过一定的时间，而这个时间由第二个参数来指定。也就是说，第二个参数指定的是“多长时间后将回调函数放入到任务队列中”。另外，即使回调函数已经进入队列，也得先等主线程的执行栈清空后才有可能轮到自己。")]),t._v(" "),n("blockquote",[n("p",[t._v("我们还经常遇到 "),n("code",[t._v("setTimeout(fn,0)")]),t._v("（或者干脆没有指定第二个参数）这样的代码，这是不是意味着可以立即执行呢？")])]),t._v(" "),n("p",[t._v("不是。"),n("code",[t._v("setTimeout(fn,0)")]),t._v(" 的意义在于，指定某个任务在主线程最早可得的空闲时间执行，意思就是注册进 Event Table 的同时就将任务放入队列中，只要主线程执行栈内的同步任务全部执行完成，且此时没有微任务队列，那么该任务就会马上压栈并执行。")]),t._v(" "),n("h3",{attrs:{id:"例二"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#例二"}},[t._v("#")]),t._v(" 例二")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'setTimeout'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Promise")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("resolve")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'promise'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'then'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nconsole"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'console'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("p",[t._v("分析：")]),t._v(" "),n("ul",[n("li",[n("code",[t._v("<script>")]),t._v("中的整段代码作为第一个宏任务，进入主线程。即开启第一次事件循环；")]),t._v(" "),n("li",[t._v("遇到 setTimeout，将其回调函数放入 Event Table 中注册，然后分发到宏任务队列中（第二个参数不设定时，默认延迟为 0）；")]),t._v(" "),n("li",[t._v("接下来遇到 new Promise、Promise，立即执行，输出: promise 。将 then 的回调函数分发到微任务队列中；")]),t._v(" "),n("li",[t._v("遇到 console.log，立即执行，输出: console")]),t._v(" "),n("li",[t._v("整体代码作为第一个宏任务执行结束，此时去微任务队列中查看有哪些微任务，结果发现了 then 的回调函数，然后将它推入主线程并执行，输出: then")]),t._v(" "),n("li",[t._v("第一轮事件循环结束，第二轮事件循环开始；")]),t._v(" "),n("li",[t._v("先从宏任务开始，去宏任务队列中查看有哪些宏任务，结果发现了 setTimeout 对应的回调函数，将它推入主线程并执行，输出：setTimeout")]),t._v(" "),n("li",[t._v("然后去微任务队列中查看是否有事件，结果没有；")]),t._v(" "),n("li",[t._v("此时第二轮事件循环结束；")]),t._v(" "),n("li",[t._v("执行栈清空了，任务队列也清空了，事件循环正式结束。")])]),t._v(" "),n("h3",{attrs:{id:"例三"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#例三"}},[t._v("#")]),t._v(" 例三")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'1'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'2'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    process"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("nextTick")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'3'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Promise")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("resolve")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'4'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'5'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nprocess"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("nextTick")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'6'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Promise")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("resolve")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'7'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'8'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'9'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    process"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("nextTick")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'10'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Promise")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("resolve")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'11'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'12'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("p",[t._v("分析：")]),t._v(" "),n("p",[n("strong",[t._v("第一轮事件循环:")])]),t._v(" "),n("p",[t._v("a) 整段 "),n("code",[t._v("<script>")]),t._v(" 代码作为第一个宏任务进入主线程，即开启第一轮事件循环\nb) 遇到 console.log，立即执行。输出：1\nc) 遇到 setTimeout，将其回调函数放入 Event table 中注册，然后分发到宏任务队列中。我们将其标记为 setTimeout1\nd) 遇到 process.nextTick，其回调函数放入 Event table 中注册，然后被分发到微任务队列中。记为 process1\ne) 遇到 new Promise、Promise，立即执行；then 回调函数放入 Event table 中注册，然后被分发到微任务队列中。记为 then1。输出: 7\nf) 遇到 setTimeout，将其回调函数放入 Event table 中注册，然后分发到宏任务队列中。我们将其标记为 setTimeout2")]),t._v(" "),n("p",[t._v("此时第一轮事件循环的宏任务结束，下表是第一轮事件循环的宏任务结束时各任务队列的情况：")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",{staticStyle:{"text-align":"center"}}),t._v(" "),n("th",{staticStyle:{"text-align":"center"}},[t._v("宏任务队列")]),t._v(" "),n("th",{staticStyle:{"text-align":"center"}},[t._v("微任务队列")])])]),t._v(" "),n("tbody",[n("tr",[n("td",{staticStyle:{"text-align":"center"}},[t._v("第一轮事件循环")]),t._v(" "),n("td",{staticStyle:{"text-align":"center"}},[t._v("（宏任务已结束）")]),t._v(" "),n("td",{staticStyle:{"text-align":"center"}},[t._v("process1、then1")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"center"}},[t._v("第二轮事件循环（未开始）")]),t._v(" "),n("td",{staticStyle:{"text-align":"center"}},[t._v("setTimeout1")]),t._v(" "),n("td",{staticStyle:{"text-align":"center"}})]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"center"}},[t._v("第三轮事件循环（未开始）")]),t._v(" "),n("td",{staticStyle:{"text-align":"center"}},[t._v("setTimeout2")]),t._v(" "),n("td",{staticStyle:{"text-align":"center"}})])])]),t._v(" "),n("p",[t._v("可以看到第一轮事件循环的宏任务结束后，微任务队列中还有两个微任务待执行，因此这两个事件会被推入主线程，然后执行")]),t._v(" "),n("p",[t._v("g）执行 process1，输出：6")]),t._v(" "),n("p",[t._v("h）执行 then1，输出：8")]),t._v(" "),n("p",[t._v("第一轮事件循环正式结束！")]),t._v(" "),n("p",[n("strong",[t._v("第二轮事件循环:")])]),t._v(" "),n("p",[t._v("a）第二轮事件循环从宏任务 setTimeout1 开始。遇到 console.log，立即执行。输出: 2\nb）遇到 process.nextTick，其回调函数放入 Event table 中注册，然后被分发到微任务队列中。记为 process2\nc）遇到 new Promise，立即执行；then 回调函数放入 Event table 中注册，然后被分发到微任务队列中。记为 then2。输出: 5")]),t._v(" "),n("p",[t._v("此时第二轮事件循环宏任务结束，下表是第二轮事件循环的宏任务结束时各任务队列的情况：")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",{staticStyle:{"text-align":"center"}}),t._v(" "),n("th",{staticStyle:{"text-align":"center"}},[t._v("宏任务事件队列")]),t._v(" "),n("th",{staticStyle:{"text-align":"center"}},[t._v("微任务事件队列")])])]),t._v(" "),n("tbody",[n("tr",[n("td",{staticStyle:{"text-align":"center"}},[t._v("第一轮事件循环（已结束）")]),t._v(" "),n("td",{staticStyle:{"text-align":"center"}}),t._v(" "),n("td",{staticStyle:{"text-align":"center"}})]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"center"}},[t._v("第二轮事件循环")]),t._v(" "),n("td",{staticStyle:{"text-align":"center"}},[t._v("（宏任务已结束）")]),t._v(" "),n("td",{staticStyle:{"text-align":"center"}},[t._v("process2、then2")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"center"}},[t._v("第三轮事件循环（未开始）")]),t._v(" "),n("td",{staticStyle:{"text-align":"center"}},[t._v("setTimeout2")]),t._v(" "),n("td",{staticStyle:{"text-align":"center"}})])])]),t._v(" "),n("p",[t._v("可以看到第二轮事件循环的宏任务结束后，微任务事件队列中还有两个微任务待执行，因此这两个微任务会被推入主线程，然后执行：")]),t._v(" "),n("p",[t._v("d) 执行 process2。输出：3\ne) 执行 then2。输出：5")]),t._v(" "),n("p",[t._v("第二轮事件循环正式结束！")]),t._v(" "),n("p",[n("strong",[t._v("第三轮事件循环：")])]),t._v(" "),n("p",[t._v("a) 第三轮事件循环从宏任务 setTimeout2 开始。遇到 console.log，立即执行。输出: 9\nb) 遇到 process.nextTick，其回调函数放入 Event table 中注册，然后被分发到微任务队列中。记为 process3\nc) 遇到 new Promise，立即执行；then 回调函数放入 Event table 中注册，然后被分发到微任务队列中。记为 then3。输出: 11")]),t._v(" "),n("p",[t._v("此时第三轮事件循环宏任务结束，下表是第三轮事件循环宏任务结束时各任务队列的情况：")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",{staticStyle:{"text-align":"center"}}),t._v(" "),n("th",{staticStyle:{"text-align":"center"}},[t._v("宏任务事件队列")]),t._v(" "),n("th",{staticStyle:{"text-align":"center"}},[t._v("微任务事件队列")])])]),t._v(" "),n("tbody",[n("tr",[n("td",{staticStyle:{"text-align":"center"}},[t._v("第一轮事件循环（已结束）")]),t._v(" "),n("td",{staticStyle:{"text-align":"center"}}),t._v(" "),n("td",{staticStyle:{"text-align":"center"}})]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"center"}},[t._v("第二轮事件循环（已结束）")]),t._v(" "),n("td",{staticStyle:{"text-align":"center"}}),t._v(" "),n("td",{staticStyle:{"text-align":"center"}})]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"center"}},[t._v("第三轮事件循环（未开始）")]),t._v(" "),n("td",{staticStyle:{"text-align":"center"}},[t._v("（宏任务已结束）")]),t._v(" "),n("td",{staticStyle:{"text-align":"center"}},[t._v("process3、then3")])])])]),t._v(" "),n("p",[t._v("可以看到第二轮事件循环宏任务结束后微任务队列中还有两个事件待执行，因此这两个事件会被推入主线程，然后执行")]),t._v(" "),n("p",[t._v("d) 执行 process3。输出：10\ne) 执行 then3。输出：12")]),t._v(" "),n("p",[t._v("第二轮事件循环正式结束！")]),t._v(" "),n("p",[t._v("最后，执行栈清空，任务队列也清空，事件循环正式结束！")]),t._v(" "),n("h2",{attrs:{id:"注意"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#注意"}},[t._v("#")]),t._v(" 注意")]),t._v(" "),n("ul",[n("li",[n("p",[t._v("微任务队列中可能有多个微任务，每次查看微任务队列，都会把里面的微任务一次性清空；")])]),t._v(" "),n("li",[n("p",[t._v("宏任务队列也可能有多个宏任务，但每次执行完一个宏任务之后，都会去清空一次微任务队列 —— 换句话说，在执行下一个宏任务之前，本次宏任务所产生的微任务必须先执行完。")])])])])}),[],!1,null,null,null);s.default=e.exports}}]);