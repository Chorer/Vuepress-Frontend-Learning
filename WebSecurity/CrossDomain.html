<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>跨域通信 | Frontend-Learning</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="https://vuepress-theme-reco.recoluan.com/favicon.ico">
    <meta name="description" content="前端面试八股文">
    
    <link rel="preload" href="/Vuepress-Frontend-Learning/assets/css/0.styles.4c119140.css" as="style"><link rel="preload" href="/Vuepress-Frontend-Learning/assets/js/app.124d66d7.js" as="script"><link rel="preload" href="/Vuepress-Frontend-Learning/assets/js/3.d90bb6d0.js" as="script"><link rel="preload" href="/Vuepress-Frontend-Learning/assets/js/1.2c4ca2ac.js" as="script"><link rel="preload" href="/Vuepress-Frontend-Learning/assets/js/80.ba5fb99f.js" as="script"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/10.3fb81d5f.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/11.bc5467f7.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/12.60e337b9.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/13.b8d6dea2.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/14.daf9d5e4.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/15.a2a94f85.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/16.0209810e.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/17.084fd80a.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/18.b5c5535b.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/19.78473768.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/20.b9c712bc.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/21.de171f7c.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/22.79481907.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/23.9a197710.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/24.cc469eb7.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/25.adfb7b53.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/26.218324b5.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/27.c7dd9602.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/28.86e37003.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/29.03d6900a.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/30.d05abd8b.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/31.f86df942.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/32.44be1a33.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/33.a0c5c185.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/34.68ad8134.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/35.2ecbc6ef.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/36.9a5f1bbb.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/37.89a54f06.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/38.27def364.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/39.53360cbd.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/4.8b752032.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/40.afd965c8.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/41.53936f76.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/42.99fcb1e2.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/43.6dcfc2b5.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/44.bc77aabc.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/45.2b134955.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/46.3c40e664.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/47.558416f2.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/48.4c08a221.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/49.9768537a.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/5.8873caea.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/50.f973d82e.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/51.7674f117.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/52.24705c78.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/53.2cf3c656.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/54.69e2b970.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/55.0eefdd3e.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/56.a1a19c22.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/57.5a5bc7bf.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/58.e5463bb9.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/59.d034b64a.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/6.c1f5de78.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/60.855a7005.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/61.31a32f38.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/62.00262306.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/63.6a3cad92.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/64.6370fc9b.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/65.77c5f2d0.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/66.c483cf9b.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/67.bed35887.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/68.a81bf5ae.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/69.fe57fd13.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/7.18d47045.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/70.ba58999a.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/71.50d883d5.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/72.78186c05.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/73.964c2de4.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/74.741ba5e3.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/75.ebfa227b.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/76.7be65790.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/77.5b8c0416.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/78.da5933f0.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/79.442aad7c.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/8.a3953fde.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/81.b9714d74.js"><link rel="prefetch" href="/Vuepress-Frontend-Learning/assets/js/9.91ba2d4a.js">
    <link rel="stylesheet" href="/Vuepress-Frontend-Learning/assets/css/0.styles.4c119140.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-1aefc0b4><div data-v-1aefc0b4><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1aefc0b4 data-v-1aefc0b4><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-25ba6db2 data-v-1aefc0b4 data-v-1aefc0b4><h3 class="title" data-v-25ba6db2 data-v-25ba6db2>Frontend-Learning</h3> <p class="description" data-v-25ba6db2 data-v-25ba6db2>前端面试八股文</p> <label id="box" class="inputBox" data-v-25ba6db2 data-v-25ba6db2><input type="password" value="" data-v-25ba6db2> <span data-v-25ba6db2>Konck! Knock!</span> <button data-v-25ba6db2>OK</button></label> <div class="footer" data-v-25ba6db2 data-v-25ba6db2><span data-v-25ba6db2><i class="iconfont reco-theme" data-v-25ba6db2></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-25ba6db2>vuePress-theme-reco</a></span> <span data-v-25ba6db2><i class="iconfont reco-copyright" data-v-25ba6db2></i> <a data-v-25ba6db2><!---->
            
          <!---->
          2021
        </a></span></div></div> <div class="hide" data-v-1aefc0b4><header class="navbar" data-v-1aefc0b4><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Vuepress-Frontend-Learning/" class="home-link router-link-active"><!----> <span class="site-name">Frontend-Learning</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask" data-v-1aefc0b4></div> <aside class="sidebar" data-v-1aefc0b4><div class="personal-info-wrapper" data-v-39576ba9 data-v-1aefc0b4><!----> <!----> <div class="num" data-v-39576ba9><div data-v-39576ba9><h3 data-v-39576ba9>69</h3> <h6 data-v-39576ba9>Articles</h6></div> <div data-v-39576ba9><h3 data-v-39576ba9>0</h3> <h6 data-v-39576ba9>Tags</h6></div></div> <ul class="social-links" data-v-39576ba9></ul> <hr data-v-39576ba9></div> <!----> <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/Vuepress-Frontend-Learning/" class="sidebar-heading clickable router-link-active"><span>关于</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/Vuepress-Frontend-Learning/CSS/Pseudo" class="sidebar-heading clickable"><span>CSS 基础知识</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/Vuepress-Frontend-Learning/JavaScript/DataTypes/Intro" class="sidebar-heading clickable"><span>JavaScript 基础知识</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/Vuepress-Frontend-Learning/HandWriting/Utils/ArrayDuplicate" class="sidebar-heading clickable"><span>JavaScript 手写系列</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/Vuepress-Frontend-Learning/Project/Module" class="sidebar-heading clickable"><span>前端工程化</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/Vuepress-Frontend-Learning/Browser/JS" class="sidebar-heading clickable"><span>浏览器</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/Vuepress-Frontend-Learning/Protocol/DNS" class="sidebar-heading clickable"><span>网络协议</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/Vuepress-Frontend-Learning/WebSecurity/CrossDomain" class="sidebar-heading clickable open active"><span>安全</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/Vuepress-Frontend-Learning/WebSecurity/CrossDomain.html" aria-current="page" class="active sidebar-link">跨域通信</a></li><li><a href="/Vuepress-Frontend-Learning/WebSecurity/WebSecurity.html" class="sidebar-link">Web 安全</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/Vuepress-Frontend-Learning/Performance/Performance" class="sidebar-heading clickable"><span>性能优化</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-25ba6db2 data-v-1aefc0b4><h3 class="title" data-v-25ba6db2 data-v-25ba6db2>跨域通信</h3> <!----> <label id="box" class="inputBox" data-v-25ba6db2 data-v-25ba6db2><input type="password" value="" data-v-25ba6db2> <span data-v-25ba6db2>Konck! Knock!</span> <button data-v-25ba6db2>OK</button></label> <div class="footer" data-v-25ba6db2 data-v-25ba6db2><span data-v-25ba6db2><i class="iconfont reco-theme" data-v-25ba6db2></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-25ba6db2>vuePress-theme-reco</a></span> <span data-v-25ba6db2><i class="iconfont reco-copyright" data-v-25ba6db2></i> <a data-v-25ba6db2><!---->
            
          <!---->
          2021
        </a></span></div></div> <div data-v-1aefc0b4><main class="page"><section><div class="page-title"><h1 class="title">跨域通信</h1> <div data-v-f875f3fc><!----> <!----> <!----> <!----></div></div> <div class="theme-reco-content content__default"><h2 id="什么是同源策略"><a href="#什么是同源策略" class="header-anchor">#</a> 什么是同源策略</h2> <blockquote><p>浏览器的同源策略即  Same-Origin Policy （SOP），它限制了不同源之间执行特定操作。</p></blockquote> <h3 id="源"><a href="#源" class="header-anchor">#</a> 源</h3> <p>一个源由<strong>协议</strong>、<strong>端口</strong>、<strong>域名</strong>组成，只要有一个不同，就认为是不同源。</p> <p>以 http://test.com/dist/demo.html 为例，不同源以及同源可能有以下情况：</p> <table><thead><tr><th>类型</th> <th>URL</th> <th>结果</th></tr></thead> <tbody><tr><td>不同协议</td> <td>https://test.com/dist/demo.html</td> <td>失败</td></tr> <tr><td>不同端口</td> <td>http://test.com:80/dist/demo.html</td> <td>失败</td></tr> <tr><td>不同域名</td> <td>http://test.cn/dist/demo.html 或者 http://www.test.com/dist/demo.html</td> <td>失败</td></tr> <tr><td>不同路径</td> <td>http://test.com/dist2/demo.html</td> <td>成功</td></tr></tbody></table> <h3 id="特定操作"><a href="#特定操作" class="header-anchor">#</a> 特定操作</h3> <p>特定操作指的是：</p> <ul><li>读取 Cookie、LocalStorage、IndexedDB</li> <li>获取 DOM 元素</li> <li>发送 AJAX 请求</li></ul> <p>为什么同源策略要禁止不同源之间进行这些操作呢？我们不妨假设一下，不存在同源策略、且不同源之间这些操作是允许的，看看可能会发生什么事。</p> <ul><li><p>如果 A 源可以读取 B 源的 Cookie、LocalStorage、IndexDB，那么等于 B 源存储的信息都暴露了，那将毫无隐私可言。所以同源策略禁止不同源之间读取 Cookie、LocalStorage、IndexDB；</p></li> <li><p>如果 A 源可以获取 B 源的 DOM 元素，那么假定用户访问了在 A 源中用 iframe 引入的 B 源网页，他的所有操作就都会在我们的掌握之中，因为我们可以在 A 源操作 B 源的 DOM 元素；</p></li> <li><p>如果 A 源可以自由发送 AJAX 请求给 B 源，那么可能会遇到 CSRF 攻击。假定现在有一个用户首先登录了 <a href="">Bank.com</a>，那么本地客户端就会保存这个网站的 Cookie （里面记录了用户在该网站的身份信息）。之后用户不小心点进了危险网站 <a href="">Evil.com</a>，这个网站做了一些设置，一旦用户进入，就自动发送 AJAX 请求给 <a href="">Bank.com</a>，由于发送请求的时候，浏览器会自动在本地检索目标网站的 Cookie ，并添加到请求报文中随着请求一起发送给目标网站，所以目标网站检测到 Cookie 确实没问题，就会响应这个请求 —— 而这个请求实际上可能执行了类似删除数据这样的敏感操作。</p></li></ul> <h2 id="如何实现跨域通信"><a href="#如何实现跨域通信" class="header-anchor">#</a> 如何实现跨域通信</h2> <p>这样看来，同源策略确实很有存在的必要，不然网络安全无从谈起。但是，有了同源策略的限制之后，A 源怎么去请求 B 源的数据呢？</p> <p>我们知道，第三方接口通常都是运行在单独的服务器上的。比如说，当前 web 页面运行在 <code>http://test.com/index.html</code> 这个服务器地址上，页面需要访问的接口运行在 <code>http://api.test.com</code> 这个服务器地址上。那么，通过浏览器访问 web 页面的时候，浏览器会针对接口地址发起 AJAX 请求，相当于 A 域需要请求 B 域的资源。</p> <p>但同源策略是禁止这种行为的，这样的话我们要怎么进行跨域通信呢？下面介绍几种常用的实现跨域的方法。但在开始之前，要先清楚一件事：</p> <blockquote><p>跨域不一定是浏览器限制了发起跨站请求，也可能是跨站请求可以正常发起，但是返回结果被浏览器拦截了。最好的例子是 CSRF 跨站攻击原理，请求是发送到了后端服务器，无论是否跨域！注意：有些浏览器不允许从 HTTPS 的域跨域访问 HTTP，比如 Chrome 和 Firefox，这些浏览器在请求还未发出的时候就会拦截请求，这是一个特例。</p></blockquote> <h3 id="_1-jsonp"><a href="#_1-jsonp" class="header-anchor">#</a> 1.JSONP</h3> <p><code>&lt;link&gt;</code> 获取 CSS，<code>&lt;script&gt;</code> 获取 JS，<code>&lt;img&gt;</code>  获取图片，这些明明也是跨域获取资源，为什么不会被禁止呢？很简单，因为这些都不属于上述特定操作之一，这里请求资源压根没用到 AJAX 请求。再看看我们的需求，我们现在是要在 A 域中获取 B 域资源，那么我完全可以在 A 域中动态创建一个 <code>script</code> 并请求 B 域资源，然后，因为 A 域中的 js 和 <code>scirpt</code> 中的 js 是在同一个作用域中的，所以要在 A 域中展示 B 域的数据也完全不成问题。虽然说法比较简陋，但这就是 JSONP 的原理。下面我们来看看具体实现：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 1.回调函数</span>
<span class="token keyword">function</span> <span class="token function">handleResponse</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 2.动态创建 script </span>
<span class="token keyword">var</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
script<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">'http://test.com/test?callback=handleResponse'</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>script<span class="token punctuation">,</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>firstChild<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>客户端：这段代码声明了一个用以接受数据的回调函数，之后动态创建了 <code>script</code> 并插入到 <code>body</code> 中，一旦执行遇到语句 <code>&lt;script src='http://test.com/test?callback=handleResponse'&gt;&lt;/script&gt;</code>，就会向服务器发起一次携带参数的请求；</li> <li>服务端：收到请求，拿到查询参数 callback 的值是 handleResponse，准备好数据 <code>data</code>，之后会生成一个对应的函数执行语句字符串，也就是 <code>handleResponse(data)</code>，这个语句返回给了客户端这边，客户端直接执行（注意：当前作用域确实声明了这个 handleResponse 函数），打印相关数据 —— 这里客户端其实已经拿到服务端的数据了，所以算是完成了一次跨域请求。</li></ul> <p>JSONP 使用起来虽然很简单，但是有如下缺点：</p> <ul><li>只能发送 GET 请求，无法发送 POST 请求</li> <li>安全问题。万一服务端那边夹带恶意代码返回过来，那么客户端这边是会直接执行的，因此有安全隐患</li> <li>无法监测 JSONP 请求是否成功或失败</li></ul> <h3 id="_2-cors"><a href="#_2-cors" class="header-anchor">#</a> 2.CORS</h3> <blockquote><p>CORS 即  Cross-origin resource sharing，跨域资源共享 ，是由 W3C 官方推广的允许通过 AJAX 技术跨域获取资源的规范 。</p></blockquote> <p>CORS 的关键在于服务端，也就是客户端这边发送请求，服务端那边做一些<strong>判断</strong>（请求方是否在自己的“白名单”里？），如果没问题就返回数据，否则拒绝。</p> <p>http 的请求实际上是分成两类的：简单请求（simple request）和非简单请求（not-so-simple request）。根据请求类型的不同，在发出跨域请求的时候，CORS 也会做不同的处理。</p> <blockquote><p>怎么才算简单请求？</p></blockquote> <p>只要<strong>同时满足</strong>以下两大条件，就属于简单请求：</p> <ul><li>请求方法是 <strong>HEAD</strong>，<strong>GET</strong>，<strong>POST</strong> 请求的其中一种；</li> <li>HTTP 的头信息只限于以下字段：
<ul><li>Accept</li> <li>Accept-Language</li> <li>Content-Language</li> <li>Last-Event-ID</li> <li>Content-Type（只能为 <code>application/x-www-form-urlencoded</code>，<code>multipart/form-data</code> 和 <code>text/plain</code> 其中一种）</li></ul></li></ul> <p>凡不同时满足以上两大条件的，都属于非简单请求。</p> <p>下面我们看一下针对这两种请求，CORS 是怎么处理。</p> <h4 id="_2-1-简单请求"><a href="#_2-1-简单请求" class="header-anchor">#</a> 2.1 简单请求</h4> <p>首先是客户端的角度，发送请求时浏览器检测到这是一个简单请求，因此在请求头额外增加一个 <code>Origin</code>，它的值是请求代码所在的源，例如 <code>http://test.com</code>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">GET</span> <span class="token operator">/</span>cors <span class="token constant">HTTP</span><span class="token operator">/</span><span class="token number">1.1</span>
Origin<span class="token operator">:</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>test<span class="token punctuation">.</span>com
Host<span class="token operator">:</span> target<span class="token punctuation">.</span>com
Accept<span class="token operator">-</span>Language<span class="token operator">:</span> en<span class="token operator">-</span><span class="token constant">US</span>
Connection<span class="token operator">:</span> keep<span class="token operator">-</span>alive
User<span class="token operator">-</span>Agent<span class="token operator">:</span> Mozilla<span class="token operator">/</span><span class="token number">5.0</span> <span class="token operator">...</span>
</code></pre></div><p>然后是服务端的角度，服务端收到请求，首先检测请求报头的 <code>Origin</code> 是否在自己的许可范围内，</p> <p>如果确实是许可的域，那么待会响应的时候，响应头会额外增加如下字段：</p> <ul><li>Access-Control-Allow-Origin（必选） ：这个字段用来告知客户端，服务端能够接受的发送 AJAX 请求的域，因为此次请求得到许可，所以这里返回与先前请求报头中 <code>Origin</code> 匹配的 <code>http://test.com</code>。当然，也可以返回 <code>*</code>，表示接受任何域的 AJAX 请求（<code>*</code> 是通配的意思）。</li> <li>Access-Control-Allow-Credentials（可选）：告知浏览器，是否允许客户端发送请求的时候携带 Cookie，true 表示允许，false 表示禁止，出于安全问题考虑（前面说过），CORS 默认不允许跨域 AJAX 请求携带 Cookie。</li> <li>Access-Control-Expose-Headers（可选）：该字段用来告知客户端暴露了哪些可以获取的响应头字段。默认情况下，xhr 的 <code>getResponseHeader()</code> 方法只能拿到 6 个基本响应头字段，如果还想额外拿到其它字段，那么前端要和后端商量好，让后端在 <code>Access-Control-Expose-Headers</code> 指定好前端可以通过该方法获取的额外响应头字段。</li></ul> <p>如果不是许可的域，那么这时候其实压根不会返回 <code>Access-Control-Allow-Origin</code> 这个响应头，而浏览器会捕获这次错误，如下图所示：</p> <p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/AJAX%20%E4%B8%8E%E8%B7%A8%E5%9F%9F%E9%80%9A%E4%BF%A1%EF%BC%88%E4%BA%8C%EF%BC%89%EF%BC%9A%E8%B7%A8%E5%9F%9F%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/AJAX%20%E4%B8%8E%E8%B7%A8%E5%9F%9F%E9%80%9A%E4%BF%A1%EF%BC%88%E4%BA%8C%EF%BC%89%EF%BC%9A%E8%B7%A8%E5%9F%9F%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-2.png" alt=""></p> <p>PS：虽然禁止跨域 AJAX 请求携带 Cookie 是为了安全考虑，但由于它在身份验证中的重要性，我们有时候还是得携带 Cookie 的。 具体方法是：</p> <ul><li>客户端配置 <code>withCredentials</code> 属性：</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
xhr<span class="token punctuation">.</span>withCredentials <span class="token operator">=</span> <span class="token boolean">true</span>
</code></pre></div><ul><li>服务端配置 <code>Access-Control-Allow-Credential</code> 为 true，配置 <code>Access-Control-Allow-Origin</code> 为指定的域（而不是 <code>*</code>），</li></ul> <h4 id="_2-2-非简单请求"><a href="#_2-2-非简单请求" class="header-anchor">#</a> 2.2 非简单请求</h4> <p>非简单请求包括两次请求，第一次请求是 preflight request，也就是预检/查询请求，这次请求试探性地“询问”服务端，自己打算进行的非简单请求是否合法 —— 不管是否合法，服务端都会通过某种方式通知客户端，客户端基于这个结果，判断是否进行第二次真正的请求。</p> <p>预检请求是这样的：</p> <p>首先是客户端的角度，发送请求时浏览器检测到这是一个非简单请求，所以事先向服务端发送一个预检请求：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">OPTIONS</span> <span class="token operator">/</span>cors <span class="token constant">HTTP</span><span class="token operator">/</span><span class="token number">1.1</span>
Origin<span class="token operator">:</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>test<span class="token punctuation">.</span>com
Access<span class="token operator">-</span>Control<span class="token operator">-</span>Request<span class="token operator">-</span>Method<span class="token operator">:</span> <span class="token constant">PUT</span>
Access<span class="token operator">-</span>Control<span class="token operator">-</span>Request<span class="token operator">-</span>Headers<span class="token operator">:</span> Custom<span class="token operator">-</span>Header1<span class="token punctuation">,</span>Custom<span class="token operator">-</span>Header2
Host<span class="token operator">:</span> target<span class="token punctuation">.</span>com
Accept<span class="token operator">-</span>Language<span class="token operator">:</span> en<span class="token operator">-</span><span class="token constant">US</span>
Connection<span class="token operator">:</span> keep<span class="token operator">-</span>alive
User<span class="token operator">-</span>Agent<span class="token operator">:</span> Mozilla<span class="token operator">/</span><span class="token number">5.0</span><span class="token operator">...</span>
</code></pre></div><ul><li><p>注意，这里这个预检请求的请求方法是 <strong>OPTIONS</strong> 。</p></li> <li><p>像之前的简单请求一样，这里浏览器会追加一个 <code>Origin</code>，表示请求代码所在的源</p></li> <li><p>前面我们说过，非简单请求会多出额外的请求头字段，这里多出来的就是 <code>Access-Control-Request-Method</code> 和 <code>Access-Control-Request-Headers</code> ，这其实是告诉服务端，“我待会要进行的真正请求，请求方法是这里 <code>Access-Control-Request-Method</code> 指定的方法，然后自定义请求头字段是这里 <code>Access-Control-Request-Headers</code> 指定的头字段，你看看行不行，给我个回应“。</p></li></ul> <p>好了，我们来看看服务器作何反应。来到服务端的角度，服务端收到这个请求，它会检测请求头中的信息，发现这个请求是合法的、没啥毛病，“好，我同意你的第二次请求”，不过光说不行，得在返回的响应头中告诉客户端这一点，此时响应头是这样的：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">HTTP</span><span class="token operator">/</span><span class="token number">1.1</span> <span class="token number">200</span> <span class="token constant">OK</span>
Date<span class="token operator">:</span> Mon<span class="token punctuation">,</span> <span class="token number">01</span> Dec <span class="token number">2008</span> <span class="token number">01</span><span class="token operator">:</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">39</span> <span class="token constant">GMT</span>
Server<span class="token operator">:</span> Apache<span class="token operator">/</span><span class="token number">2.0</span><span class="token number">.61</span>（Unix）
Access<span class="token operator">-</span>Control<span class="token operator">-</span>Allow<span class="token operator">-</span>Origin<span class="token operator">:</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>test<span class="token punctuation">.</span>com
Access<span class="token operator">-</span>Control<span class="token operator">-</span>Allow<span class="token operator">-</span>Methods<span class="token operator">:</span> <span class="token constant">GET</span><span class="token punctuation">,</span> <span class="token constant">POST</span><span class="token punctuation">,</span> <span class="token constant">PUT</span>
Access<span class="token operator">-</span>Control<span class="token operator">-</span>Allow<span class="token operator">-</span>Headers<span class="token operator">:</span> Custom<span class="token operator">-</span>Header1<span class="token punctuation">,</span>Custom<span class="token operator">-</span>Header2
Access<span class="token operator">-</span>Control<span class="token operator">-</span>Max<span class="token operator">-</span>Age<span class="token operator">:</span> <span class="token number">1728000</span>
Content<span class="token operator">-</span>type<span class="token operator">:</span> text<span class="token operator">/</span>html<span class="token punctuation">;</span> charset<span class="token operator">=</span>utf<span class="token operator">-</span><span class="token number">8</span>
Content<span class="token operator">-</span>Encoding<span class="token operator">:</span> gzip
Content<span class="token operator">-</span>Length<span class="token operator">:</span> <span class="token number">0</span>
Keep<span class="token operator">-</span>Alive<span class="token operator">:</span> timeout<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> max<span class="token operator">=</span><span class="token number">100</span>
Connection<span class="token operator">:</span> Keep<span class="token operator">-</span>Alive
Content<span class="token operator">-</span>Type<span class="token operator">:</span> text<span class="token operator">/</span>plain
</code></pre></div><ul><li>Access-Control-Allow-Origin：这里和之前一样，可以是 http://test.com 或者 <code>*</code>，也就是告诉客户端，“我给你的域下了许可证“</li> <li>Access-Control-Allow-Methods：这里告诉客户端，服务端允许的跨域 AJAX 请求的类型，”虽然你刚才告诉我你准备进行的是 PUT 请求，不过你要进行 GET 或者 POST 请求，我也是允许的“</li> <li>Access-Control-Allow-Headers：这里告诉客户端，服务端允许的发送请求时的自定义请求头</li> <li>Access-Control-Max-Age: 这里告诉客户端预检请求的有效期，省去了多次的预检请求。也就是说，”我给你开个后门，1728000 秒内（20天内）你可以直接发送真正的 AJAX 请求，不用每次都来问我了“</li></ul> <p>再回到客户端这边，客户端收到响应，知道服务端允许了自己的请求，于是进行第二次真正的 AJAX 跨域请求。此后每次 CORS 请求都相当于一次简单请求了。</p> <p>但是，如果发现客户端的请求是不合法的，那么服务端虽然会返回正常响应，但不会返回 CORS 相关的响应头，而客户端这边”心领神会“，知道被拒绝了，所以由 xhr 对象捕获这个错误，如下图所示：</p> <p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/AJAX%20%E4%B8%8E%E8%B7%A8%E5%9F%9F%E9%80%9A%E4%BF%A1%EF%BC%88%E4%BA%8C%EF%BC%89%EF%BC%9A%E8%B7%A8%E5%9F%9F%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/AJAX%20%E4%B8%8E%E8%B7%A8%E5%9F%9F%E9%80%9A%E4%BF%A1%EF%BC%88%E4%BA%8C%EF%BC%89%EF%BC%9A%E8%B7%A8%E5%9F%9F%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-3.png" alt=""></p> <p>我们可以来解读一下这个报错：</p> <p>不管预检请求成功还是失败，服务端都会返回一个响应。客户端针对这个响应会进行一次 access control check，检查响应是否携带 Access-Control-Allow-Origin 头部字段，如果没有的话，则此次 check 失败，预检请求失败，抛出错误。</p> <h3 id="_3-图像-ping"><a href="#_3-图像-ping" class="header-anchor">#</a> 3.图像 Ping</h3> <ul><li>图像 Ping 是与服务器进行简单、单向的跨域通信的一种方式，请求的数据是通过查询字符串形式发送的，而响应可以是任意内容，通常是像素图和 204 响应。浏览器虽然得不到任何具体数据，但由于可以监听 load 和 error 事件，所以能知道响应是什么时候接受到的。</li> <li>图像 Ping 最常用于跟踪用户点击页面或动态广告曝光次数</li> <li>缺点：单向通信，只支持 GET 请求；无法访问服务器的响应文本</li></ul> <h3 id="_4-document-domain"><a href="#_4-document-domain" class="header-anchor">#</a> 4.document.domain</h3> <p>介绍 document.domain 跨域之前，先解释一下域名的一些概念。</p> <ul><li>顶级域名：诸如 .com、.cn、.net、.org 等都是顶级域名，也叫一级域名</li> <li>二级域名：诸如 baidu.com、zhihu.com、mdn.org 等</li> <li>父域名、子域名：这是相对的概念，诸如 .com 是 tool.com 的父域名，而 tool.com 的子域名是 editor.tool.com，editor.tool.com 的子域名是 www.editor.tool.com</li></ul> <p>document.domain 适用于<strong>主域相同、子域不同</strong>的两个域之间的跨域通信。假设我现在有一个A域为  http://www.test.com/a.html  ，另一个B域为  http://test.com/b.html  ，因为是不同源的（域名不相同），所以我不能在A域中拿到B域的东西，但是呢，我们注意到这两个域的主域是相同的，只是子域不同而已，所以我们可以用 document.domain 的方法实现跨域，具体来说，就是重新设置两个页面的 document.domain 为一个相同的值。</p> <p>但要注意的是，document.domain 的设置是有限制的，我们只能把 document.domain 设置成<strong>自身或更高一级的父域，且主域必须始终保持相同</strong>。例如：a.b.test.com 中某个文档的 document.domain 可以设成a.b.test.com（自身）、b.test.com（上一级父域） 、test.com（上上一级父域）中的任意一个，但是不可以设成 c.a.b.test.com（下一级子域），因为这是当前域的子域，也不可以设成 baidu.com，因为主域已经不相同了，这里的主域必须始终保持为 test.com 不变。</p> <p>来看代码：</p> <p>A域  http://www.test.com/a.html  ：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span> http://test.com/b.html<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>myIframe<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">onload</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value javascript language-javascript"><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    document<span class="token punctuation">.</span>domain <span class="token operator">=</span> <span class="token string">'test.com'</span><span class="token punctuation">;</span> <span class="token comment">// 设置成主域（比自己高一级的父域）</span>
    <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'myIframe'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>contentWindow<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>B域  http://test.com/b.html ：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    document<span class="token punctuation">.</span>domain <span class="token operator">=</span> <span class="token string">'test.com'</span><span class="token punctuation">;</span> <span class="token comment">// 虽然本来就是 test.com，但还是要显式设置一次</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>之后，我们就可以在 A 域中拿到 B 域的东西了。注意，尽管这时候 document.domain 是一样的，但两个域之间只是可以交互而已，仍然不能发送 AJAX 请求。</p> <h3 id="_5-window-name"><a href="#_5-window-name" class="header-anchor">#</a> 5.window.name</h3> <p>首先要明白一件事 —— window 对象有个 name 属性，在一个窗口的生命周期内，<code>window.name</code> 会被该窗口的所有页面所共享、所读写，不管这些页面是同源还是不同源。</p> <p>那么，我们岂不是可以把数据放在 <code>window.name</code> 里，然后通过页面跳转把这些数据拿到自己这边来？有道理，不过每次要拿数据就得跳转页面，好像有点麻烦，不妨我们把这个页面跳转的过程放在 <code>iframe</code> 里进行。假定请求数据的页面是 a.html，存放数据的页面是 c.html，那么我们在 a.html 中通过 <code>iframe</code> 加载 c.html，这时候数据已经存放在 <code>iframe</code> 这个窗口的 <code>window.name</code> 里了，之后我们让其跳转到与 a.html 同源的 b.html，根据前面说的，<code>window.name</code> 仍然是被保留的、可访问的，那么 <code>window.name</code>  由 c 传递到了 b，并且由于此时 a.html、b.html 同源，所以 <code>window.name</code>  又可经由 b 传递给 a。</p> <p>下面说说代码实现：</p> <div class="language-html extra-class"><pre class="language-html"><code>// c.html
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/javascript<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    window<span class="token punctuation">.</span>name <span class="token operator">=</span> 我是要传递的 json 数据<span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-html extra-class"><pre class="language-html"><code>// b.html
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
	我只是一个中转站
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-html extra-class"><pre class="language-html"><code>// a.html

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>hello world<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">var</span> p <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> isFirst <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> iframe <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'iframe'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

iframe<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">'http://localhost:3001/c.html'</span><span class="token punctuation">;</span> 
iframe<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">'none'</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>iframe<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//监听 iframe 的两次加载（分别是加载 c.html 和 b.html 的时候）</span>
iframe<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>isFirst<span class="token punctuation">)</span><span class="token punctuation">{</span>
        iframe<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">'http://localhost:3000/b.html'</span><span class="token punctuation">;</span>
        isFirst <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        p<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> iframe<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
        <span class="token comment">// 销毁iframe</span>
        iframe<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>iframe<span class="token punctuation">)</span><span class="token punctuation">;</span>
        iframe<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
        iframe <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>这里动态创建了 <code>iframe</code>，并指定第一次加载的 <code>iframe</code> 是 c.html，一旦加载好（很显然这时候 <code>window.name</code> 的值已经记录在这个窗口里了），就执行回调函数，通过修改 src 让页面跳转到 b.html（这时候 <code>window.name</code> 的值传递给了 b.html），第二次触发执行回调函数，将最初的数据传递给 a.html。</p> <p>注意两个地方：</p> <ul><li>由于整个过程是悄悄进行的，我们给 <code>iframe</code> 设置 <code>display:none</code></li> <li>拿到数据后记得销毁 <code>iframe</code>，防止内存泄露</li></ul> <p>上面的写法不需要重写 onload 回调函数，只用一个 flag 标识第一和第二次加载；我们也可以采用下面的方法重写 onload 回调：</p> <div class="language-js extra-class"><pre class="language-js"><code>iframe<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    iframe<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        p<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> iframe<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
        iframe<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>iframe<span class="token punctuation">)</span><span class="token punctuation">;</span>
        iframe<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
        iframe <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    iframe<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">'http://localhost:3000/b.html'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_6-postmessage"><a href="#_6-postmessage" class="header-anchor">#</a> 6.postMessage</h3> <p>HTML5 提供了 <code>postMessage</code>  和 <code>onmessage</code> 两个 api 用于在跨域站点页面之间进行通信。</p> <p><strong>注意：这里一定要记住，不是发送端的窗口去调用 <code>postMessage</code> 方法，而是接收端的窗口去调用</strong></p> <p>举个例子，假设 A 域要向 B 域发送消息，那么：</p> <ul><li>一方面，我们在 A 域页面中通过 <code>iframe</code> 引入 B 域，通过这个 <code>iframe</code> 调用 <code>postMessage</code>方法发送消息给 B 域。这个方法接受两个参数，第一个参数是发送的消息， 它可以是任何类型的数据，但部分浏览器只支持字符串格式；第二个参数是可以接受消息的域，这里是 B 域 —— 如果不想限定某个域去接受消息，那么可以传 <code>*</code>。</li> <li>另一方面，B域监听 <code>onmessage</code> 事件，一旦接收到消息就调用某个函数接受数据。<code>onmessage</code>  事件的事件对象有三个属性，<code>event.data</code> 表示接受到的数据，<code>event.origin</code> 为消息发送方的源，<code>event.source</code> 为消息发送方的窗口对象的引用。</li></ul> <p>B 域接收到了消息，要通知 A 域，其实就是上面的过程反过来。</p> <p>B 域要向 A 域发送消息，那么：</p> <ul><li>一方面，B 域的 <code>window.parent</code> 可以访问父级（A域）窗口对象，我们在 B 域里通过该对象调用 <code>postMessage</code>  方法，发送通知给 A 域</li> <li>另一方面，A域监听 <code>onmessage</code> 事件，收到B域通知，进行相应处理</li></ul> <p>核心代码如下：</p> <div class="language-html extra-class"><pre class="language-html"><code>http://test.com/a.html

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>myIframe<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://anothertest.com/b.html<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
	<span class="token keyword">const</span> iframe <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#myIframe'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    iframe<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        iframe<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'我是数据'</span><span class="token punctuation">,</span><span class="token string">'http://anothertest.com/b.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    window<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'我收到的B域通知是:'</span><span class="token operator">+</span> event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 我收到的B域通知是:B域收到A域的消息了，通知你一声</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-html extra-class"><pre class="language-html"><code>http://anothertest.com/b.html

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
	window<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'我接受到的消息是:'</span><span class="token operator">+</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//我接受到的消息是:我是数据</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'发送消息的源是:'</span><span class="token operator">+</span>event<span class="token punctuation">.</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'发送消息的窗口对象是:'</span><span class="token operator">+</span>event<span class="token punctuation">.</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
        window<span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'B域收到A域的消息了，通知你一声'</span><span class="token punctuation">,</span><span class="token string">'http://test.com/a.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>那么这就是简单的跨域窗口间通信了，不过这只是客户端层面上的，如果A域的客户端要发送 AJAX 请求给B域服务端呢？只要稍微改进上面的方法就可以，也就是说，B域客户端充当一个中转站，A 域客户端先通过上面的方法把数据发送给B域客户端，B域客户端再把数据转发给B域服务端（这两个是同源的，直接发送 AJAX 请求）；然后，反过来也一样，B域返回的数据经由B域客户端交给A域客户端。</p> <p>代码如下：</p> <div class="language-html extra-class"><pre class="language-html"><code>http://anothertest.com/b.html

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
	window<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">'http://anothertest.com/test.php?msg='</span> <span class="token operator">+</span> event<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
        <span class="token function">request</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 发送请求</span>
    <span class="token keyword">function</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        xhr<span class="token punctuation">.</span>onreadystatechange <span class="token operator">=</span> response<span class="token punctuation">;</span>
        xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 返回响应结果</span>
    <span class="token keyword">function</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>status <span class="token operator">&gt;=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> xhr<span class="token punctuation">.</span>status <span class="token operator">&lt;</span><span class="token number">300</span><span class="token punctuation">)</span> <span class="token operator">||</span> xhr<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">304</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                  window<span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'服务端返回的数据是:'</span><span class="token operator">+</span> xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">,</span><span class="token string">'http://test.com/a.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>另外还要关注安全问题。 postMessage 本质上是依赖于客户端脚本设置了相应的 <code>message</code> 监听事件，因此只要有消息通过<code>postMessage</code>发送过来，我们的脚本都会接收并进行处理 —— 而任何域都可以通过 <code>postMessage</code> 发送跨域信息，因此对于设置了事件监听器的页面来说，判断到达页面的信息是否安全是非常重要的。通常可以通过 <code>event.origin</code> 检测消息方是否在消息源白名单中。</p> <h3 id="_7-location-hash"><a href="#_7-location-hash" class="header-anchor">#</a> 7.location.hash</h3> <p>默认情况下，改变页面的 url 会导致页面跳转，但是 hash 是个例外，譬如将 http://test.com/a.html#hash 改为 http://test.com/a.html#anotherhash ，并不会引起页面跳转，所以我们可以利用 hash 来传输数据。</p> <p>假设A域有 a.html 和 b.html，B域有 c.html，且 a.html 和 c.html 之间要进行跨域通信。</p> <ul><li>一方面，我们在 a.html 中通过 <code>iframe</code> 引入 c.html，引用的 src 带上 hash —— 实际上这时候已经<strong>通过 hash 的方式把数据传给 c.html 了</strong></li> <li>另一方面，在 c.html 中，我们对这个数据进行一些处理，之后想办法返回给 a.html。怎么返回呢？假定 a、c 同域，那么可以通过将数据赋值给  <code>window.parent.location.hash</code> 的方式，让 a.html 的 hash 改变，同时 a.html 监听这个改变，保存传过来的数据。但问题是，a、c 是不同源的，我们无法在 c.html 中通过 <code>window.parent</code> 去访问 a.html。那么谁能和 a.html 直接通信呢？肯定是和 a.html 同源的 html，因此我们想到，在 c.html 中利用 <code>iframe</code> 引入与 a.html 同源的 b.html，引用的 src 带上 hash —— 实际上这时候已经<strong>通过 hash 的方式把数据传给 b.html 了</strong>，而 b.html 拿到数据后，由于它和 a.html 是同源的，所以可以直接将数据赋值给 <code>window.parent.parent.location.hash</code> ，之后，a.html 监听 hash 改变，保存数据。</li></ul> <p>如下图所示：</p> <p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/AJAX%20%E4%B8%8E%E8%B7%A8%E5%9F%9F%E9%80%9A%E4%BF%A1%EF%BC%88%E4%B8%89%EF%BC%89/AJAX%E4%B8%8E%E8%B7%A8%E5%9F%9F%E9%80%9A%E4%BF%A1%EF%BC%88%E4%B8%89%EF%BC%89-1.jpg" alt=""></p> <p>下面我们看一下代码是怎么写的。</p> <p>像前面说的，我们创建 <code>iframe</code> 引用 c.html，通过 hash 传值，同时监听 a.html 的 hash 改变 —— 这里有两种方式，我们可以直接用 onhashchange 监听，也可以设置一个定时器，每隔两秒轮询一次 hash，一旦改变就打印数据。</p> <div class="language-html extra-class"><pre class="language-html"><code>// a.html

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>No changes yet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">var</span> p <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> iframe <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'iframe'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
iframe<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">'http://localhost:3001/c.html#getdata'</span><span class="token punctuation">;</span>   <span class="token comment">// location.hash为'#getdata'</span>
iframe<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">'none'</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>iframe<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// 原生 onhashchange 监听，有些浏览器不支持 onhashchange</span>
window<span class="token punctuation">.</span><span class="token function-variable function">onhashchange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> data <span class="token operator">=</span> location<span class="token punctuation">.</span>hash <span class="token operator">?</span> location<span class="token punctuation">.</span>hash<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span>
    p<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//定时器轮询 hash</span>
<span class="token comment">// function checkHash() {</span>
<span class="token comment">//     let data = location.hash ? location.hash.substring(1) : ''</span>
<span class="token comment">//     p.innerHTML = data;</span>
<span class="token comment">// }</span>
<span class="token comment">// setInterval(checkHash, 2000);   // 每隔2s监听hash值是否发生变化</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>这里我们根据不同的参数采取不同的处理，因为传过来的是 <code>#getdata</code>，所以调用 <code>callBack</code> 函数，函数首先尝试直接用 <code>parent.location.hash</code> 改变 a.html 的 hash，发现是不同源的，更改失败，改为将数据传给 b.html。</p> <div class="language-html extra-class"><pre class="language-html"><code>// c.html

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">switch</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>hash<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'#getdata'</span><span class="token operator">:</span>
        <span class="token function">callBack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'#getAnotherData'</span><span class="token operator">:</span>
        <span class="token comment">//do something……</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">callBack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> message <span class="token operator">=</span> <span class="token string">'name=Sam'</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        parent<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash <span class="token operator">=</span> message<span class="token punctuation">;</span>   <span class="token comment">// 因为不同域，这里通过 parent.location.hash 直接更改会报错</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 采用 b.html 作为中转站</span>
        <span class="token keyword">var</span> ifrproxy <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'iframe'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ifrproxy<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">'none'</span><span class="token punctuation">;</span>
        ifrproxy<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">'http://localhost:3000/b.html#'</span> <span class="token operator">+</span> message<span class="token punctuation">;</span> <span class="token comment">// 注意该文件在3000端口下</span>
        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>ifrproxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>由于 b.html 和 a.html 同源，所以可以直接更改 a.html 的 hash。更改后触发 a.html 中的事件，打印数据。</p> <div class="language-html extra-class"><pre class="language-html"><code>// b.html

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
	parent<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash <span class="token operator">=</span> self<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash<span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>location.hash 跨域的大致过程就是这样，当然，它的缺点也很明显：</p> <ul><li>数据直接暴露在了 url 中</li> <li>数据容量和类型有限</li></ul> <h3 id="_8-websocket"><a href="#_8-websocket" class="header-anchor">#</a> <strong>8.WebSocket</strong></h3> <p>传统的 http 协议有一个缺陷：通信只能由客户端发起，服务端无法主动向客户端推送信息。比如，服务端这边某个状态发生变化，它是无法主动通知客户端的，而只能由客户端采用轮询的方式，每隔一段时间发送一次请求进行探测。</p> <p>这时候出现了一种新的叫做 WebSocket 的协议，它使用<code>ws://</code>（非加密）和 <code>wss://</code>（加密）作为协议前缀，特点在于支持全双工通信 —— 客户端可以主动向服务端发送信息，服务端也可以主动向客户端推送信息 。那么这和跨域有什么关系呢？事实上，WebSocket 本身就不受同源策略的影响，这意味着，一旦客户端与服务端建立的是 WebSocket 连接，天然就可以实现跨域资源共享。</p> <h4 id="_1-建立-websocket-连接"><a href="#_1-建立-websocket-连接" class="header-anchor">#</a> 1）建立 WebSocket 连接</h4> <p>客户端要求升级至 WebSocket 协议：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">GET</span> <span class="token operator">/</span>chat <span class="token constant">HTTP</span><span class="token operator">/</span><span class="token number">1.1</span>
Host<span class="token operator">:</span> server<span class="token punctuation">.</span>example<span class="token punctuation">.</span>com
Upgrade<span class="token operator">:</span> websocket
Connection<span class="token operator">:</span> Upgrade
Sec<span class="token operator">-</span>WebSocket<span class="token operator">-</span>Key<span class="token operator">:</span> x3JJHMbDL1EzLkh9GBhXDw<span class="token operator">==</span>
Sec<span class="token operator">-</span>WebSocket<span class="token operator">-</span>Protocol<span class="token operator">:</span> chat<span class="token punctuation">,</span> superchat
Sec<span class="token operator">-</span>WebSocket<span class="token operator">-</span>Version<span class="token operator">:</span> <span class="token number">13</span>
Origin<span class="token operator">:</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>example<span class="token punctuation">.</span>com
</code></pre></div><p>服务端同意升级：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">HTTP</span><span class="token operator">/</span><span class="token number">1.1</span> <span class="token number">101</span> Switching Protocols
Upgrade<span class="token operator">:</span> websocket
Connection<span class="token operator">:</span> Upgrade
Sec<span class="token operator">-</span>WebSocket<span class="token operator">-</span>Accept<span class="token operator">:</span> HSmrc0sMlYUkAGmm5OPpG2HaGWk<span class="token operator">=</span>
Sec<span class="token operator">-</span>WebSocket<span class="token operator">-</span>Protocol<span class="token operator">:</span> chat
</code></pre></div><h4 id="_2-发起请求"><a href="#_2-发起请求" class="header-anchor">#</a> 2）发起请求</h4> <p>同源策略限制了不同源之间无法发送 AJAX 请求，但是 WebSocket 发送的并不是 AJAX 请求，而是 WebSocket 请求。在了解怎么发起 ws 请求之前，先看一下一些相关属性。</p> <ul><li><code>WebSocket</code>对象的<code>readyState</code>属性用来表示对象实例当前所处的连接状态，有四个值：
<ul><li><strong>0</strong>：表示正在连接中（CONNECTING）；</li> <li><strong>1</strong>：表示连接成功，可以通信（OPEN）；</li> <li><strong>2</strong>：表示连接正在关闭（CLOSING）；</li> <li><strong>3</strong>：表示连接已经关闭或打开连接失败（CLOSED）；</li></ul></li> <li>另外还有四个事件属性：
<ul><li><code>onopen</code>：用于指定连接成功后的回调函数；</li> <li><code>onclose</code>：用于指定连接关闭后的回调函数；</li> <li><code>onmessage</code>：用于指定收到服务器数据后的回调函数；</li> <li><code>onerror</code>：用于指定报错时的回调函数；</li></ul></li> <li>另外还提供了 <code>bufferedAmount</code>属性，表示还剩下多少字节的二进制数据没有发送出去</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">'ws://localhost:3001'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ws://localhost:3000是响应请求的地址</span>
ws<span class="token punctuation">.</span><span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'连接成功，准备发送信息!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'发送信息'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>    
ws<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'后端返回的是'</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>不过， 原生的 WebSocket API 使用起来不太方便，可以使用 Socket.io，它很好地封装了 WebSocket 接口，提供了更简单、灵活的接口，也对不支持 WebSocket 的浏览器提供了向下兼容。</p> <h3 id="_9-nginx-反向代理"><a href="#_9-nginx-反向代理" class="header-anchor">#</a> 9.Nginx 反向代理</h3> <h3 id="_10-nodejs-中间件代理"><a href="#_10-nodejs-中间件代理" class="header-anchor">#</a> 10.Nodejs 中间件代理</h3></div></section> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/Vuepress-Frontend-Learning/Protocol/WebSocket.html" class="prev">
            WebSocket 协议
          </a></span> <span class="next"><a href="/Vuepress-Frontend-Learning/WebSecurity/WebSecurity.html">
            Web 安全
          </a></span></p></div> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-cb1513f6><li class="level-2" data-v-cb1513f6><a href="/Vuepress-Frontend-Learning/WebSecurity/CrossDomain.html#什么是同源策略" class="sidebar-link reco-side-什么是同源策略" data-v-cb1513f6>什么是同源策略</a></li><li class="level-3" data-v-cb1513f6><a href="/Vuepress-Frontend-Learning/WebSecurity/CrossDomain.html#源" class="sidebar-link reco-side-源" data-v-cb1513f6>源</a></li><li class="level-3" data-v-cb1513f6><a href="/Vuepress-Frontend-Learning/WebSecurity/CrossDomain.html#特定操作" class="sidebar-link reco-side-特定操作" data-v-cb1513f6>特定操作</a></li><li class="level-2" data-v-cb1513f6><a href="/Vuepress-Frontend-Learning/WebSecurity/CrossDomain.html#如何实现跨域通信" class="sidebar-link reco-side-如何实现跨域通信" data-v-cb1513f6>如何实现跨域通信</a></li><li class="level-3" data-v-cb1513f6><a href="/Vuepress-Frontend-Learning/WebSecurity/CrossDomain.html#_1-jsonp" class="sidebar-link reco-side-_1-jsonp" data-v-cb1513f6>1.JSONP</a></li><li class="level-3" data-v-cb1513f6><a href="/Vuepress-Frontend-Learning/WebSecurity/CrossDomain.html#_2-cors" class="sidebar-link reco-side-_2-cors" data-v-cb1513f6>2.CORS</a></li><li class="level-3" data-v-cb1513f6><a href="/Vuepress-Frontend-Learning/WebSecurity/CrossDomain.html#_3-图像-ping" class="sidebar-link reco-side-_3-图像-ping" data-v-cb1513f6>3.图像 Ping</a></li><li class="level-3" data-v-cb1513f6><a href="/Vuepress-Frontend-Learning/WebSecurity/CrossDomain.html#_4-document-domain" class="sidebar-link reco-side-_4-document-domain" data-v-cb1513f6>4.document.domain</a></li><li class="level-3" data-v-cb1513f6><a href="/Vuepress-Frontend-Learning/WebSecurity/CrossDomain.html#_5-window-name" class="sidebar-link reco-side-_5-window-name" data-v-cb1513f6>5.window.name</a></li><li class="level-3" data-v-cb1513f6><a href="/Vuepress-Frontend-Learning/WebSecurity/CrossDomain.html#_6-postmessage" class="sidebar-link reco-side-_6-postmessage" data-v-cb1513f6>6.postMessage</a></li><li class="level-3" data-v-cb1513f6><a href="/Vuepress-Frontend-Learning/WebSecurity/CrossDomain.html#_7-location-hash" class="sidebar-link reco-side-_7-location-hash" data-v-cb1513f6>7.location.hash</a></li><li class="level-3" data-v-cb1513f6><a href="/Vuepress-Frontend-Learning/WebSecurity/CrossDomain.html#_8-websocket" class="sidebar-link reco-side-_8-websocket" data-v-cb1513f6>8.WebSocket</a></li><li class="level-3" data-v-cb1513f6><a href="/Vuepress-Frontend-Learning/WebSecurity/CrossDomain.html#_9-nginx-反向代理" class="sidebar-link reco-side-_9-nginx-反向代理" data-v-cb1513f6>9.Nginx 反向代理</a></li><li class="level-3" data-v-cb1513f6><a href="/Vuepress-Frontend-Learning/WebSecurity/CrossDomain.html#_10-nodejs-中间件代理" class="sidebar-link reco-side-_10-nodejs-中间件代理" data-v-cb1513f6>10.Nodejs 中间件代理</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/Vuepress-Frontend-Learning/assets/js/app.124d66d7.js" defer></script><script src="/Vuepress-Frontend-Learning/assets/js/3.d90bb6d0.js" defer></script><script src="/Vuepress-Frontend-Learning/assets/js/1.2c4ca2ac.js" defer></script><script src="/Vuepress-Frontend-Learning/assets/js/80.ba5fb99f.js" defer></script>
  </body>
</html>
